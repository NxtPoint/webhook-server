<!DOCTYPE html>
<html lang="en" data-ui-version="v3">
<head>
  <meta charset="UTF-8" />
  <title>Upload Match Video</title>
  <style>
    html, body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: url('{{ url_for("ui.static", filename="upload/background-clean-male-serve.jpg") }}');
      background-size: cover;
      color: #ffffff;
    }
    .overlay { background: rgba(0, 0, 0, 0.6); min-height: 100vh; display: flex; justify-content: center; align-items: start; padding: 24px; }
    .container { background: rgba(0, 128, 0, 0.2); border: 2px solid #00ff80; border-radius: 15px; padding: 20px; width: 100%; max-width: 720px; text-align: left; box-shadow: 0 0 20px #00ff80; }
    h2 { font-size: 1.6rem; margin: 0 0 12px 0; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .row-1 { display: grid; grid-template-columns: 1fr; gap: 12px; }
    label { font-size: .9rem; opacity: .95; }
    input, select { width: 100%; padding: 10px; border-radius: 8px; border: none; font-size: 1rem; margin-top: 6px; }
    input[type="checkbox"] { width: auto; margin-right: 8px; }
    .btn { background-color: #00ff80; color: #000; padding: 12px 16px; border: none; border-radius: 10px; font-size: 1rem; cursor: pointer; transition: transform .05s ease, opacity .2s ease; }
    .btn:hover { transform: translateY(-1px); }
    .btn.secondary { background: transparent; border: 1px solid #00ff80; color: #fff; }
    .btn[disabled] { opacity: .5; cursor: not-allowed; }
    .stack { display: flex; gap: 10px; flex-wrap: wrap; margin: 10px 0; }
    .progress-bar { background-color: #ffffff40; border-radius: 8px; margin-top: 10px; height: 12px; overflow: hidden; }
    .progress-bar-fill { height: 100%; width: 0%; background-color: #00ff80; transition: width 0.3s ease-in-out; }
    .spinner { display: none; margin: 20px 0; border: 6px solid #ccc; border-top: 6px solid #00ff80; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    #status { background: rgba(255, 255, 255, 0.1); border-radius: 10px; padding: 12px; margin-top: 10px; font-size: 0.95rem; white-space: pre-wrap; text-align: left; border: 1px solid #00ff80; min-height: 60px; }
    #subtasks { margin-top: 8px; font-size: 0.9rem; opacity: .95; }
    #subtasks code { display:block; background: rgba(0,0,0,.25); padding:8px; border-radius:8px; border:1px solid #00ff80; }
    .pill { display:inline-block; padding:4px 8px; border-radius:999px; border:1px solid #00ff80; background: rgba(0,0,0,.2); font-size:.85rem; margin-top:8px; }
    .warn { color:#fca5a5; }
    .fineprint { opacity: .85; font-size: .85rem; margin-top: 10px; line-height: 1.4; }
    .divider { height: 1px; background: #00ff80; opacity: .35; margin: 14px 0; }
  </style>
</head>
<body>
  <div class="overlay">
    <div class="container" data-max-mb="{{ max_upload_mb }}">
      <h2>üéæ NextPoint ‚Äî Upload Match Video</h2>

      {% if not dropbox_ready %}<div class="pill warn">Dropbox credentials are not configured.</div>{% endif %}
      {% if not sportai_ready %}<div class="pill warn">SPORT_AI_TOKEN is not configured.</div>{% endif %}
      <div class="pill">Target folder: <strong>{{ target_folder }}</strong></div>
      <div class="pill">UI: v3</div>

      <!-- META -->
      <div class="divider"></div>
      <div class="row-1">
        <label>Customer name (account contact) ‚Äî required
          <input type="text" id="customer_name" placeholder="e.g., Jane Smith" required />
        </label>
      </div>
      <div class="row">
        <label>Email (becomes your Customer ID) ‚Äî required
          <input type="email" id="email" placeholder="you@example.com" required />
        </label>
        <label>Match date (optional)
          <input type="date" id="match_date" />
        </label>
      </div>
      <div class="row">
        <label>Start time (optional)
          <input type="time" id="start_time" />
        </label>
        <label>Location / Court (optional)
          <input type="text" id="location" placeholder="e.g., Club ABC Court 2" />
        </label>
      </div>
      <div class="row">
        <label>Player A (near camera, serves first) ‚Äî default ‚ÄúPlayer A‚Äù
          <input type="text" id="player_a_name" placeholder="First Last (optional)" />
        </label>
        <label>Player B (receiver) ‚Äî default ‚ÄúPlayer B‚Äù
          <input type="text" id="player_b_name" placeholder="First Last (optional)" />
        </label>
      </div>
      <div class="row">
        <label>Player A UTR (optional)
          <input type="text" id="player_a_utr" placeholder="e.g., 7.41" />
        </label>
        <label>Player B UTR (optional)
          <input type="text" id="player_b_utr" placeholder="e.g., 8.02" />
        </label>
      </div>

      <!-- VIDEO -->
      <div class="divider"></div>
      <div class="row-1">
        <label>Match video file (.mp4 or .mov) ‚Äî required
          <input type="file" id="video" accept=".mp4,.mov" />
        </label>
      </div>

      <!-- TERMS -->
      <div class="row-1">
        <label><input type="checkbox" id="terms" /> I accept that processing takes time, AI can make mistakes, and I agree to the Terms & Conditions.</label>
        <div class="fineprint">
          For any queries contact <a href="mailto:info@nextpointtennis.com">info@nextpointtennis.com</a>.
        </div>
      </div>

      <!-- ACTIONS -->
      <div class="divider"></div>
      <div class="stack">
        <button class="btn secondary" id="btnCheck">Check video</button>
        <button class="btn" id="btnUpload" disabled>Upload to SportAI</button>
        <button class="btn secondary" id="btnCancel" disabled>Cancel task</button>
      </div>

      <div class="spinner" id="spinner"></div>
      <div class="progress-bar"><div class="progress-bar-fill" id="progressFill"></div></div>
      <div id="status"></div>
      <div id="subtasks"></div>

      <div class="divider"></div>
      <div class="fineprint">
        Tip: Please run <b>Check video</b> first to avoid charges on incompatible videos.
      </div>
    </div>
  </div>

  <script>
    const q = sel => document.querySelector(sel);
    const statusBox = q('#status');
    const subtasksBox = q('#subtasks');
    const spinner = q('#spinner');
    const fill = q('#progressFill');
    const MAX_MB = parseInt(q('.container').dataset.maxMb || '150', 10);
    const MAX_BYTES = MAX_MB * 1024 * 1024;

    // State
    let lastShareUrl = null;
    let lastVideoUrl = null;
    let currentTaskId = null;
    let pollTimer = null;

    // Helpers
    const ui = {
      clear() { statusBox.textContent = ''; subtasksBox.innerHTML = ''; ui.progress(0); },
      say(m) { statusBox.textContent += (statusBox.textContent ? '\n' : '') + m; },
      progress(pct) { fill.style.width = Math.max(0, Math.min(100, pct)) + '%'; },
      spin(on) { spinner.style.display = on ? 'block' : 'none'; }
    };

    const fields = {
      customer_name: () => q('#customer_name').value.trim(),
      email:        () => q('#email').value.trim().toLowerCase(),
      match_date:   () => q('#match_date').value.trim(),
      start_time:   () => q('#start_time').value.trim(),
      location:     () => q('#location').value.trim(),
      player_a_name:() => q('#player_a_name').value.trim(),
      player_b_name:() => q('#player_b_name').value.trim(),
      player_a_utr: () => q('#player_a_utr').value.trim(),
      player_b_utr: () => q('#player_b_utr').value.trim(),
      terms_ok:     () => q('#terms').checked,
    };

    function validateRequired() {
      if (!fields.customer_name()) { ui.say('‚ùå Customer name is required.'); return false; }
      if (!fields.email()) { ui.say('‚ùå Email is required.'); return false; }
      if (!fields.terms_ok()) { ui.say('‚ùå You must accept the Terms & Conditions.'); return false; }
      const f = q('#video').files[0];
      if (!f) { ui.say('‚ùå Please choose a video file (.mp4 or .mov).'); return false; }
      if (f.size > MAX_BYTES) {
        ui.say(`‚ùå File is ${Math.round(f.size/1024/1024)}MB > ${MAX_MB}MB (server limit). Try a smaller clip.`);
        return false;
      }
      return true;
    }

    function metaPayload() {
      return {
        customer_name: fields.customer_name(),
        match_date: fields.match_date(),
        start_time: fields.start_time(),
        location: fields.location(),
        player_a_name: fields.player_a_name() || 'Player A',
        player_b_name: fields.player_b_name() || 'Player B',
        player_a_utr: fields.player_a_utr(),
        player_b_utr: fields.player_b_utr()
      };
    }

    function renderSubtasks(obj) {
      if (!obj || typeof obj !== 'object') { subtasksBox.innerHTML = ''; return; }
      try { subtasksBox.innerHTML = `<strong>Subtask progress:</strong><code>${JSON.stringify(obj, null, 2)}</code>`; }
      catch { subtasksBox.innerHTML = ''; }
    }

    async function readJson(res) {
      const txt = await res.text();
      try { return JSON.parse(txt); } catch { return { _raw: txt }; }
    }

    // --- Check video ---
    q('#btnCheck').addEventListener('click', async () => {
      ui.clear(); ui.spin(true);
      const f = q('#video').files[0];
      if (!validateRequired()) { ui.spin(false); return; }

      const fd = new FormData();
      fd.append('file', f);

      // NB: we only upload once we pass check
      try {
        const res = await fetch('/upload/api/check', { method: 'POST', body: fd });
        const data = await readJson(res);

        if (!res.ok || data?.error) {
          ui.say(`‚ùå Check failed: ${data?.error || (res.status + ' ' + res.statusText)}`);
          ui.spin(false);
          q('#btnUpload').disabled = true;
          return;
        }
        lastShareUrl = data.share_url || null;
        lastVideoUrl = data.video_url || null;

        ui.say('‚úÖ Video check passed.');
        if (lastShareUrl) ui.say(`üìé Source: ${lastShareUrl}`);
        q('#btnUpload').disabled = false; // enable upload after passing check
      } catch (e) {
        ui.say(`‚ùå Check failed: ${String(e)}`);
      } finally {
        ui.spin(false);
      }
    });

    // --- Upload & submit ---
    q('#btnUpload').addEventListener('click', async () => {
      ui.spin(true);
      if (!validateRequired()) { ui.spin(false); return; }

      const f = q('#video').files[0];
      const fd = new FormData();
      fd.append('video', f);
      fd.append('email', fields.email());
      // Pass metadata through (backend will ignore harmlessly if not used)
      const meta = metaPayload();
      Object.entries(meta).forEach(([k,v]) => fd.append(k, v));

      try {
        const res = await fetch('/upload', { method: 'POST', body: fd });
        const data = await readJson(res);

        if (!res.ok || data?.error) {
          ui.say(`‚ùå Upload error: ${data?.error || (res.status + ' ' + res.statusText)}`);
          ui.spin(false); return;
        }

        currentTaskId = data.task_id || data.sportai_task_id;
        if (!currentTaskId) {
          ui.say('‚ùå No task id returned.');
          ui.spin(false); return;
        }

        ui.say('‚úÖ Uploaded & registered with SportAI. Starting analysis‚Ä¶');
        if (data.share_url) ui.say(`üìé Source: ${data.share_url}`);

        q('#btnCancel').disabled = false;
        startPolling(currentTaskId);
      } catch (e) {
        ui.say(`‚ùå Upload exception: ${String(e)}`);
        ui.spin(false);
      }
    });

    // --- Cancel ---
    q('#btnCancel').addEventListener('click', async () => {
      if (!currentTaskId) { ui.say('No active task to cancel.'); return; }
      try {
        const res = await fetch(`/upload/api/cancel?task_id=${encodeURIComponent(currentTaskId)}`, { method: 'POST' });
        const data = await readJson(res);
        if (!res.ok || data?.error) {
          ui.say(`‚ùå Cancel failed: ${data?.error || (res.status + ' ' + res.statusText)}`);
          return;
        }
        ui.say('üõë Task cancel requested.');
      } catch (e) {
        ui.say(`‚ùå Cancel exception: ${String(e)}`);
      }
    });

    // --- Polling ---
    async function tick(taskId) {
      try {
        const res = await fetch(`/upload/api/task-status?task_id=${encodeURIComponent(taskId)}`);
        const data = await readJson(res);

        const d = data?.data || {};
        const status = d.task_status || data?.status || 'unknown';
        const progress = (typeof d.task_progress === 'number') ? d.task_progress : 0;
        const totalSub = (typeof d.total_subtask_progress === 'number') ? d.total_subtask_progress : null;
        const pct = Math.round(progress * 100);
        ui.progress(pct);

        if (d.subtask_progress) renderSubtasks(d.subtask_progress);

        if (status === 'completed') {
          ui.progress(100);
          ui.say('‚úÖ Analysis complete! JSON downloaded and ingested.');
          stopPolling();
          ui.spin(false);
        } else if (status === 'failed') {
          ui.say('‚ùå Analysis failed. Please try another video.');
          stopPolling();
          ui.spin(false);
        } else {
          const extra = (totalSub !== null) ? ` | subtasks ${Math.round(totalSub * 100)}%` : '';
          ui.say(`üîÑ Status: ${status} (${pct}%)${extra}`);
        }
      } catch (e) {
        ui.say(`‚ùå Polling failed: ${String(e)}`);
        stopPolling();
        ui.spin(false);
      }
    }

    function startPolling(taskId) {
      stopPolling();
      ui.progress(40);
      ui.say('üì° Waiting for analysis to complete‚Ä¶');
      pollTimer = setInterval(() => tick(taskId), 5000);
    }
    function stopPolling() {
      if (pollTimer) { clearInterval(pollTimer); pollTimer = null; }
      q('#btnCancel').disabled = true;
    }

    // Initial
    ui.clear();
    q('#btnUpload').disabled = true; // force check first
  </script>
</body>
</html>
