<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Upload & Submit • NextPoint</title>
<style>
  :root{
    /* darker green to match the background graphs */
    --accent: #16A34A;         /* emerald-600 */
    --accent-strong: #15803D;  /* emerald-700 */
    --accent-soft: #EAF6EF;
    --text: #111;
    --muted: #6b7280;
    --field-bg: #f6f7f8;
    --field-border: #e5e7eb;
    --card-bg: rgba(255,255,255,0.92);
    --top-offset: 110px; /* push card down to show more of player */
  }

  html,body{height:100%;}
  body{
    margin:0;
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    color:var(--text);
    background:
      linear-gradient(rgba(0,0,0,0.20), rgba(0,0,0,0.35)),
      url("{{ url_for('static', filename='upload/background-clean-male-serve.jpg') }}") center/cover fixed no-repeat;
  }
  .wrap{min-height:100%;display:flex;align-items:flex-start;justify-content:center;padding-top:var(--top-offset);}
  .card{
    width:min(980px, 92vw);
    background:var(--card-bg);
    border-radius:16px;
    box-shadow:0 10px 30px rgba(0,0,0,0.15);
    backdrop-filter: blur(2px);
    padding:22px 22px 14px;
    margin:0 auto 90px;
  }

  h1{font-size:20px;margin:0 0 12px;font-weight:700;}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px 16px;}
  .grid .full{grid-column:1/-1;}

  label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px;}
  input[type="text"],input[type="email"],input[type="date"],
  input[type="time"],input[type="number"]{
    width:100%;box-sizing:border-box;background:var(--field-bg);
    border:1px solid var(--field-border);border-radius:10px;
    padding:10px 12px;font-size:14px;outline:none;color:var(--text);
  }
  input::placeholder{color:#b5b9bf;}
  input:focus{border-color:#d1d5db;box-shadow:0 0 0 3px rgba(22,163,74,0.12);background:#fff;}
  input.done{background:#fff;border-color:#d1d5db;}
  .terms{display:flex;align-items:center;gap:8px;font-size:13px;color:#111;}
  .terms input[type="checkbox"]{accent-color:var(--accent);}

  .btn{
    appearance:none;border:0;cursor:pointer;width:100%;
    padding:12px 18px;border-radius:10px;
    background:var(--accent);color:#fff;font-weight:700;
  }
  .btn:hover{background:var(--accent-strong);}

  .section-title{margin:12px 0 6px;font-weight:700;font-size:14px;color:#0f172a;}
  .divider{height:1px;background:#e5e7eb;margin:12px 0;}

  /* Compact chips with label ABOVE value */
  .chip-row{display:flex;gap:10px;align-items:flex-end;flex-wrap:wrap;}
  .chip{
    display:flex;flex-direction:column;gap:2px;
    background:var(--accent-soft);padding:8px 10px;border-radius:10px;
    min-width:220px;
  }
  .chip small{font-size:11px;letter-spacing:.02em;text-transform:uppercase;color:#0b5a37;font-weight:800;opacity:.75;}
  .chip .val{font-weight:700;color:#0b5a37;word-break:break-all;}

  /* Progress block */
  .progress-block{display:flex;align-items:flex-end;gap:16px;flex-wrap:wrap;margin:6px 0 6px;}
  .progress-left{min-width:220px}
  .progress-right{flex:1;min-width:260px;display:flex;align-items:center;gap:10px;}
  .bar-wrap{flex:1;min-width:220px;}
  .bar-label{font-size:11px;letter-spacing:.02em;text-transform:uppercase;color:#0b5a37;font-weight:800;margin-bottom:6px;}
  .bar{
    position:relative;height:16px;border-radius:9999px;background:#e6efe8;overflow:hidden;
    box-shadow:inset 0 0 0 1px rgba(0,0,0,0.04);
  }
  .bar .fill{
    position:absolute;left:0;top:0;bottom:0;width:0%;
    background:var(--accent);
    transition:width 400ms ease;
  }
  .bar .pct{
    position:absolute;inset:0;display:flex;align-items:center;justify-content:center;
    font-size:12px;font-weight:800;color:#fff;text-shadow:0 1px 1px rgba(0,0,0,.25);
    pointer-events:none;
  }
  .anchors{display:flex;justify-content:space-between;margin-top:6px;color:#0b5a37;font-size:11px;font-weight:700;opacity:.75}

  /* Log: white + ~10 lines */
  .log{
    background:#fff;color:#111;border:1px solid #e5e7eb;
    border-radius:10px;padding:10px;
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    font-size:12px;line-height:1.25;
    max-height:12.5em; /* ~10 lines @ 1.25 */
    overflow:auto;white-space:pre-wrap;
  }

  @media (max-width:780px){
    .grid{grid-template-columns:1fr;}
    .progress-right{min-width:0;}
  }
</style>
</head>
<body>
<div class="wrap">
  <div class="card" id="card">
    <h1>Upload & Submit</h1>

    <form id="form" enctype="multipart/form-data" class="grid">
      <div class="full">
        <label>Video file (max 150 MB)</label>
        <input type="file" id="file" name="file" accept="video/*" required />
      </div>

      <div>
        <label>Customer name</label>
        <input type="text" name="customer_name" placeholder="Customer" />
      </div>
      <div>
        <label>Email *</label>
        <input type="email" name="email" placeholder="you@example.com" required />
      </div>

      <div>
        <label>Start time of first point (HH:MM:SS)</label>
        <input type="text" name="start_time" placeholder="00:00:00" />
      </div>
      <div>
        <label>Match date (YYYY-MM-DD)</label>
        <input type="date" name="match_date" placeholder="yyyy/mm/dd" />
      </div>

      <div>
        <label>Location</label>
        <input type="text" name="location" placeholder="Court / Venue (optional)" />
      </div>
      <div></div>

      <div>
        <label>Player A name</label>
        <input type="text" name="player_a_name" placeholder="Player A" />
      </div>
      <div>
        <label>Player A UTR</label>
        <input type="number" step="0.1" name="player_a_utr" placeholder="(optional)" />
      </div>

      <div>
        <label>Player B name</label>
        <input type="text" name="player_b_name" placeholder="Player B" />
      </div>
      <div>
        <label>Player B UTR</label>
        <input type="number" step="0.1" name="player_b_utr" placeholder="(optional)" />
      </div>

      <div class="full terms">
        <input type="checkbox" id="terms" name="terms_accepted" />
        <label for="terms">I accept the terms</label>
      </div>

      <div class="full">
        <button type="submit" class="btn" id="submitBtn">Upload and Submit</button>
      </div>

      <div class="full divider"></div>

      <!-- STATUS -->
      <div class="full">
        <div class="section-title">Status</div>

        <div class="chip-row">
          <div class="chip">
            <small>TASK ID</small>
            <div class="val" id="taskId">—</div>
          </div>
          <div class="chip">
            <small>STATUS</small>
            <div class="val" id="stage">waiting…</div>
          </div>
        </div>

        <div class="progress-block">
          <div class="progress-left"></div>
          <div class="progress-right">
            <div class="bar-wrap">
              <div class="bar-label">PROGRESS %</div>
              <div class="bar">
                <div class="fill" id="barFill" style="width:0%"></div>
                <div class="pct" id="pctInside">0%</div>
              </div>
              <div class="anchors"><span>0%</span><span>100%</span></div>
            </div>
          </div>
        </div>

        <div class="muted">
          <a id="linkRaw" href="#" target="_blank" rel="noopener">Raw status</a>
          &nbsp;•&nbsp;
          <a id="linkResult" href="#" target="_blank" rel="noopener" style="display:none">Result JSON</a>
        </div>
      </div>

      <div class="full">
        <div class="section-title">Log</div>
        <div class="log" id="log"></div>
      </div>
    </form>
  </div>
</div>

<script>
(function(){
  const form = document.getElementById('form');
  const logBox = document.getElementById('log');
  const stageEl = document.getElementById('stage');
  const taskIdEl = document.getElementById('taskId');
  const barFill = document.getElementById('barFill');
  const pctInside = document.getElementById('pctInside');
  const linkRaw = document.getElementById('linkRaw');
  const linkRes = document.getElementById('linkResult');
  const submitBtn = document.getElementById('submitBtn');
  const card = document.getElementById('card');

  let pollTimer = null;
  let pseudo = makePseudoProgress();

  function log(line){
    const ts = new Date().toLocaleTimeString();
    logBox.textContent += `${ts} ${line}\n`;
    logBox.scrollTop = logBox.scrollHeight;
  }
  function setProgress(p){
    if (p == null || Number.isNaN(p)) p = 0;
    p = Math.max(0, Math.min(100, Math.round(p)));
    pctInside.textContent = p + '%';
    barFill.style.width = p + '%';
  }
  function markDone(){
    stageEl.textContent = 'completed';
    setProgress(100);
    card.querySelectorAll('input').forEach(i => i.classList.add('done'));
    submitBtn.disabled = false;
  }
  function makePseudoProgress(){
    let p = 0;
    return {
      reset(){ p = 0; },
      tick(){
        if (p < 90){ p += Math.max(0.2, (90 - p) * 0.015); }
        return Math.min(90, Math.round(p));
      }
    };
  }
  async function poll(tid){
    if (!tid) return;
    try{
      const r = await fetch(`/upload/api/task-status?task_id=${encodeURIComponent(tid)}`, {cache:'no-store'});
      const j = await r.json();
      linkRaw.href = `/upload/task_status?task_id=${encodeURIComponent(tid)}`;
      const status = (j.status || '').toLowerCase() || (j.data && (j.data.task_status || j.data.status)) || 'processing';
      stageEl.textContent = status;

      if (j.result_url){ linkRes.style.display = ''; linkRes.href = j.result_url; }

      let prog = null;
      const d = j.data || {};
      prog = d.task_progress ?? d.progress ?? j.task_progress ?? j.progress ?? null;
      if (prog == null) prog = (status === 'completed') ? 100 : pseudo.tick();
      setProgress(prog);

      if (status === 'completed' || status === 'success' || status === 'succeeded' || prog >= 100){
        markDone();
        clearInterval(pollTimer); pollTimer = null;
        log('analysis complete ✓');
      }
    }catch(e){ log(`status error: ${e}`); }
  }

  form.addEventListener('submit', async (ev)=>{
    ev.preventDefault();
    logBox.textContent = '';
    linkRes.style.display = 'none';
    stageEl.textContent = 'processing';
    setProgress(0);
    pseudo.reset();
    submitBtn.disabled = true;

    const fd = new FormData(form);
    const f = fd.get('file');
    if (!f || !f.name){ submitBtn.disabled = false; return; }

    log('uploading to file server…');
    try{
      const r = await fetch('/upload/api/upload', { method:'POST', body:fd });
      const j = await r.json();

      if (!j.ok){ submitBtn.disabled = false; log(`error: ${j.error || 'upload failed'}`); return; }

      log(`uploaded ${f.name} (${f.size} bytes)`);
      log(`task ${j.task_id} submitted to Analytics Console…`);

      taskIdEl.textContent = j.task_id || '—';
      stageEl.textContent = 'processing';
      linkRaw.href = `/upload/task_status?task_id=${encodeURIComponent(j.task_id)}`;

      clearInterval(pollTimer);
      pollTimer = setInterval(()=>poll(j.task_id), 2000);
      poll(j.task_id);
    }catch(e){ submitBtn.disabled = false; log(`error: ${e}`); }
  });
})();
</script>
</body>
</html>
