<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Upload & Submit • NextPoint</title>

<style>
  :root{
    /* brand-ish green that matches the background charts */
    --accent: #28C07B;         /* main */
    --accent-strong: #1EA466;  /* hover/active */
    --accent-soft: #E8F7F0;    /* chips/bg */
    --text: #111;
    --muted: #6b7280;
    --field-bg: #f6f7f8;       /* inputs idle */
    --field-border: #e5e7eb;   /* subtle borders */
    --card-bg: rgba(255,255,255,0.92);
  }

  html,body{height:100%;}
  body{
    margin:0;
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    color:var(--text);
    background:
      linear-gradient(rgba(0,0,0,0.2), rgba(0,0,0,0.35)),
      url("{{ url_for('static', filename='upload/background-clean-male-serve.jpg') }}") center/cover fixed no-repeat;
  }

  .wrap{
    min-height:100%;
    display:flex;
    align-items:flex-start;
    justify-content:center;
  }
  .card{
    width:min(980px, 92vw);
    margin:28px auto 64px;
    background:var(--card-bg);
    border-radius:16px;
    box-shadow:0 10px 30px rgba(0,0,0,0.15);
    backdrop-filter: blur(2px);
    padding:22px 22px 12px;
  }

  h1{font-size:20px;margin:0 0 12px 0;font-weight:700;}
  .grid{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap:12px 16px;
  }
  .grid .full{grid-column: 1 / -1;}

  label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px;}
  input[type="text"],
  input[type="email"],
  input[type="date"],
  input[type="time"],
  input[type="number"]{
    width:100%;
    box-sizing:border-box;
    background:var(--field-bg);
    border:1px solid var(--field-border);
    border-radius:10px;
    padding:10px 12px;
    font-size:14px;
    outline:none;
  }
  input::placeholder{color:#b5b9bf;}

  input:focus{
    border-color:#d1d5db;
    box-shadow:0 0 0 3px rgba(40,192,123,0.12);
    background:#fff;
  }

  input.done{ background:#fff; border-color:#d1d5db; }

  .btn{
    appearance:none;border:0;cursor:pointer;
    padding:12px 18px;border-radius:10px;
    background:var(--accent);color:#fff;font-weight:700;
    width:100%;
  }
  .btn:hover{ background:var(--accent-strong); }

  .bar{
    height:10px;border-radius:9999px;background:#e5efe9;overflow:hidden;
  }
  .bar > .fill{
    height:100%;width:0%;
    background:var(--accent);
    transition:width 400ms ease;
  }

  .section-title{margin:12px 0 6px;font-weight:700;font-size:14px;color:#0f172a;}
  .chip-row{
    display:flex;gap:10px;align-items:center;flex-wrap:wrap;
  }
  .chip{
    display:inline-flex;align-items:center;gap:6px;
    background:var(--accent-soft);
    color:#0b5a37;
    border-radius:9999px;
    padding:6px 10px;
    font-size:12px;font-weight:600;
    white-space:nowrap;
  }
  .chip .label{opacity:0.65;font-weight:700;text-transform:uppercase;letter-spacing:.02em;font-size:11px;}
  .status-line{
    display:flex;align-items:center;gap:12px;margin:6px 0 10px;
  }
  .status-line .spacer{flex:1;min-width:120px}
  .status-line .bar{height:8px;min-width:220px;max-width:420px;flex:0 1 38%}

  .links a{font-size:12px;color:#0b5a37;text-decoration:underline;}

  .log{
    background:#0b1220;color:#cbd5e1;
    border-radius:10px;padding:10px;
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    font-size:12px;line-height:1.25;
    max-height:10.5em; /* ~10 lines */
    overflow:auto; white-space:pre-wrap;
  }

  .terms{display:flex;align-items:center;gap:8px;font-size:13px;color:#111;}
  .muted{color:var(--muted);font-size:12px;}

  .divider{height:1px;background:#e5e7eb;margin:12px 0;}

  @media (max-width:780px){
    .grid{ grid-template-columns: 1fr; }
    .status-line{ flex-direction:column; align-items:flex-start; }
    .status-line .bar{ width:100%; max-width:none; min-width:0; }
    .btn{ margin-top:6px; }
  }
</style>
</head>
<body>
  <div class="wrap">
    <div class="card" id="card">
      <h1>Upload & Submit</h1>

      <form id="form" enctype="multipart/form-data" class="grid">
        <div class="full">
          <label>Video file (max 150 MB)</label>
          <input type="file" id="file" name="file" accept="video/*" required />
        </div>

        <div>
          <label>Customer name</label>
          <input type="text" name="customer_name" placeholder="Customer" />
        </div>
        <div>
          <label>Email *</label>
          <input type="email" name="email" placeholder="you@example.com" required />
        </div>

        <div>
          <label>Start time of first point (HH:MM:SS)</label>
          <input type="text" name="start_time" placeholder="00:00:00" />
        </div>
        <div>
          <label>Match date (YYYY-MM-DD)</label>
          <input type="date" name="match_date" />
        </div>

        <div>
          <label>Location</label>
          <input type="text" name="location" placeholder="Court / Venue (optional)" />
        </div>
        <div></div>

        <div>
          <label>Player A name</label>
          <input type="text" name="player_a_name" placeholder="Player A" />
        </div>
        <div>
          <label>Player A UTR</label>
          <input type="number" step="0.1" name="player_a_utr" placeholder="(optional)" />
        </div>

        <div>
          <label>Player B name</label>
          <input type="text" name="player_b_name" placeholder="Player B" />
        </div>
        <div>
          <label>Player B UTR</label>
          <input type="number" step="0.1" name="player_b_utr" placeholder="(optional)" />
        </div>

        <div class="full terms">
          <input type="checkbox" id="terms" name="terms_accepted" />
          <label for="terms">I accept the terms</label>
        </div>

        <div class="full">
          <button type="submit" class="btn" id="submitBtn">Upload and Submit</button>
        </div>

        <div class="full divider"></div>

        <!-- STATUS -->
        <div class="full">
          <div class="section-title">Status</div>

          <div class="status-line">
            <div class="chip"><span class="label">Task Id</span><span id="taskId">–</span></div>
            <div class="chip"><span class="label">Status</span><span id="stage">waiting…</span></div>
            <div class="chip"><span class="label">Progress %</span><span id="pct">0%</span></div>
            <div class="spacer"></div>
            <div class="bar"><div class="fill" id="barFill" style="width:0%"></div></div>
          </div>

          <div class="links">
            <a id="linkRaw" href="#" target="_blank" rel="noopener">Raw status</a>
            &nbsp;•&nbsp;
            <a id="linkResult" href="#" target="_blank" rel="noopener" style="display:none">Result JSON</a>
          </div>
        </div>

        <div class="full">
          <div class="section-title">Log</div>
          <div class="log" id="log"></div>
        </div>
      </form>
    </div>
  </div>

<script>
(function(){
  const form = document.getElementById('form');
  const logBox = document.getElementById('log');
  const stageEl = document.getElementById('stage');
  const taskIdEl = document.getElementById('taskId');
  const pctEl   = document.getElementById('pct');
  const barFill = document.getElementById('barFill');
  const card    = document.getElementById('card');
  const linkRaw = document.getElementById('linkRaw');
  const linkRes = document.getElementById('linkResult');
  const submitBtn = document.getElementById('submitBtn');

  let pollTimer = null;
  let lastPct = 0;
  let pseudo = makePseudoProgress();

  function log(line){
    const ts = new Date().toLocaleTimeString();
    logBox.textContent += `${ts} ${line}\n`;
    logBox.scrollTop = logBox.scrollHeight;
  }

  function setProgress(p){
    if (p == null || Number.isNaN(p)) p = 0;
    p = Math.max(0, Math.min(100, Math.round(p)));
    lastPct = p;
    pctEl.textContent = p + '%';
    barFill.style.width = p + '%';
  }

  function markDone(){
    stageEl.textContent = 'completed';
    setProgress(100);
    card.querySelectorAll('input').forEach(i => i.classList.add('done'));
    submitBtn.disabled = false;
  }

  function makePseudoProgress(){
    // Smoothly creeps to 90% over ~2 minutes, then waits for completion hop to 100
    let p = 0;
    return {
      reset(){ p = 0; },
      tick(){
        if (p < 90){
          // ease out a touch
          p += Math.max(0.2, (90 - p) * 0.015);
        }
        return Math.min(90, Math.round(p));
      }
    };
  }

  async function poll(tid){
    if (!tid) return;
    try{
      const r = await fetch(`/upload/api/task-status?task_id=${encodeURIComponent(tid)}`, {cache:'no-store'});
      const j = await r.json();
      // Build raw link
      linkRaw.href = `/upload/task_status?task_id=${encodeURIComponent(tid)}`;
      // Stage
      const status = (j.status || '').toLowerCase() || (j.data && (j.data.task_status || j.data.status)) || 'processing';
      stageEl.textContent = status;
      // Result link
      if (j.result_url){
        linkRes.style.display = '';
        linkRes.href = j.result_url;
      }
      // Progress (real if present; otherwise pseudo)
      let prog = null;
      const d = j.data || {};
      // prefer explicit numbers if present
      prog = d.task_progress ?? d.progress ?? j.task_progress ?? j.progress ?? null;
      if (prog == null) prog = (status === 'completed') ? 100 : pseudo.tick();
      setProgress(prog);

      if (status === 'completed' || status === 'success' || status === 'succeeded' || prog >= 100){
        markDone();
        clearInterval(pollTimer); pollTimer = null;
        log('analysis complete ✓');
      }
    }catch(e){
      // keep polling; just log once in a while
      log(`status error: ${e}`);
    }
  }

  form.addEventListener('submit', async (ev)=>{
    ev.preventDefault();
    logBox.textContent = '';
    linkRes.style.display = 'none';
    stageEl.textContent = 'processing';
    setProgress(0);
    pseudo.reset();
    submitBtn.disabled = true;

    const fd = new FormData(form);
    const f = fd.get('file');
    if (!f || !f.name){
      submitBtn.disabled = false;
      return;
    }

    log('uploading to file server…');
    try{
      const r = await fetch('/upload/api/upload', { method:'POST', body:fd });
      const j = await r.json();

      if (!j.ok){
        submitBtn.disabled = false;
        log(`error: ${j.error || 'upload failed'}`);
        return;
      }

      log(`uploaded ${f.name} (${f.size} bytes)`);
      log(`task ${j.task_id} submitted to Analytics Console…`);

      taskIdEl.textContent = j.task_id || '—';
      stageEl.textContent = 'processing';
      linkRaw.href = `/upload/task_status?task_id=${encodeURIComponent(j.task_id)}`;

      // start polling
      clearInterval(pollTimer);
      pollTimer = setInterval(()=>poll(j.task_id), 2000);
      poll(j.task_id);
    }catch(e){
      submitBtn.disabled = false;
      log(`error: ${e}`);
    }
  });
})();
</script>
</body>
</html>
