<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Upload & Submit • NextPoint</title>
<style>
  :root{
    --brand:#0b5a37;          /* primary green */

    --accent-soft:#EAF6EF;
    --text:#111827;
    --muted:#6b7280;
    --field-bg:#f6f7f8;
    --field-border:#e5e7eb;
    --card-bg:rgba(255,255,255,0.92);

    /* vertical placement */
    --top-offset:220px;       /* lift everything a bit (smaller value = higher) */
  }

  html,body{height:100%;}
  body{
    margin:0;color:var(--text);
    font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";
    background:
      linear-gradient(rgba(0,0,0,0.20), rgba(0,0,0,0.35)),
      url("{{ url_for('static', filename='upload/background-clean-male-serve.jpg') }}") center/cover fixed no-repeat;
    /* keep the viewport still; scrolling happens inside the fixed wrapper */
    overflow:hidden;
  }

  /* Fixed container so the card doesn't move on scroll */
  .wrap{
    position:fixed; inset:0;
    display:flex; align-items:flex-start; justify-content:center;
    padding-top:var(--top-offset);
    overflow:auto;          /* allow internal scrolling if content is tall */
  }

  .card{
    width:min(980px,92vw);
    background:var(--card-bg);
    border-radius:16px;
    box-shadow:0 10px 30px rgba(0,0,0,0.15);
    backdrop-filter:blur(2px);
    padding:22px 22px 36px;   /* extra bottom padding for breathing room */
    margin:0 auto 90px;       /* keep nice margin under the card */
  }
  h1{font-size:20px;margin:0 0 12px;font-weight:700;}

  .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px 16px;}
  .grid .full{grid-column:1/-1;}

  label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px;}
  input[type="text"],input[type="email"],input[type="date"],input[type="number"]{
    width:100%;box-sizing:border-box;background:var(--field-bg);
    border:1px solid var(--field-border);border-radius:10px;padding:10px 12px;font-size:14px;outline:none;color:var(--text);
  }
  input::placeholder{color:#b5b9bf;}
  input:focus{border-color:#d1d5db;box-shadow:0 0 0 3px rgba(11,90,55,0.15);background:#fff;}
  input.done{background:#fff;border-color:#d1d5db;}

  /* File input button — brand green */
  input[type="file"]{border:0;background:transparent;padding:0;}
  input[type="file"]::file-selector-button{
    margin-right:10px;border:0;border-radius:10px;background:var(--brand);color:#fff;
    padding:10px 12px;font-weight:700;cursor:pointer;
  }
  input[type="file"]::file-selector-button:hover{filter:brightness(.92);}

  .terms{display:flex;align-items:center;gap:8px;font-size:13px;color:#111;}
  .terms input[type="checkbox"]{accent-color:var(--brand);}

  .btn{appearance:none;border:0;cursor:pointer;padding:12px 18px;border-radius:10px;font-weight:700;color:#fff;background:var(--brand);}
  .btn:hover{filter:brightness(.92);}
  .btn[disabled]{opacity:.55;cursor:not-allowed;}
  .btn-outline{background:transparent;color:var(--brand);border:1.5px solid var(--brand);border-radius:10px;}
  .btn-outline:hover{background:var(--accent-soft);}
  .btn-row{display:flex;gap:10px}
  .divider{height:1px;background:#e5e7eb;margin:12px 0;}

  /* STATUS ROW — titles aligned; progress slightly wider; bottoms align to bar */
  .status-row{
    display:grid;
    grid-template-columns: 1.2fr 0.9fr 2.1fr; /* task id | status | progress (wider) */
    gap:12px;
    align-items:end;        /* align bottoms (task id / status values to bar) */
    margin-top:6px;
    overflow:visible;
  }
  .col{display:flex;flex-direction:column;justify-content:flex-end;min-height:56px;}
  .col-title{
    font-size:14px;font-weight:700;color:#0f172a;margin:0 0 6px 0;line-height:1;font-family:inherit;
  }
  /* Tiny nudge so PROGRESS % heading sits exactly level with the others */
  .status-row .col:last-child .col-title{ transform:translateY(-1px); }

  .col-value{font-weight:600;word-break:break-all;color:var(--brand);}
  .mono{font-family:ui-monospace,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;}

  /* Progress bar — same green as buttons */
  .bar-wrap{width:100%;position:relative;}
  .bar{position:relative;height:16px;border-radius:9999px;background:#e6efe8;overflow:hidden;box-shadow:inset 0 0 0 1px rgba(0,0,0,0.04);}
  .bar .fill{position:absolute;left:0;top:0;bottom:0;width:0%;background:var(--brand);transition:width 400ms ease;}
  .bar .pct{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:800;color:#fff;text-shadow:0 1px 1px rgba(0,0,0,.25);pointer-events:none;}
  .anchors{
    position:absolute;left:0;right:0;bottom:-18px;
    display:flex;justify-content:space-between;color: var(--brand);font-size:11px;font-weight:700;opacity:.9;pointer-events:none;
  }

  /* Log box — white, ~10 lines */
  .log{background:#fff;color:#111;border:1px solid #e5e7eb;border-radius:10px;padding:10px;
       font-family:ui-monospace,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
       font-size:12px;line-height:1.25;max-height:10.5em;overflow:auto;white-space:pre-wrap;}

  /* T&C accordion */
  details.tnc{margin:8px 0 4px;}
  details.tnc summary{cursor:pointer;font-weight:700;color:#111;}

  @media (max-width:900px){
    .status-row{grid-template-columns: 1fr;}
    .col{min-height:auto;}
  }
</style>
</head>
<body>
<div class="wrap">
  <div class="card" id="card">
    <h1>Upload & Submit</h1>

    <form id="form" enctype="multipart/form-data" class="grid">
      <div class="full">
        <label>Video file (max 150 MB)</label>
        <input type="file" id="file" name="file" accept="video/*" required />
      </div>

      <div>
        <label>Customer name</label>
        <input type="text" name="customer_name" placeholder="Customer" />
      </div>
      <div>
        <label>Email *</label>
        <input type="email" name="email" placeholder="you@example.com" required />
      </div>

      <div>
        <label>Start time of first point (HH:MM:SS)</label>
        <input type="text" name="start_time" placeholder="00:00:00" />
      </div>
      <div>
        <label>Match date (YYYY-MM-DD)</label>
        <input type="date" id="match_date" name="match_date" placeholder="yyyy/mm/dd" />
      </div>

      <div>
        <label>Location</label>
        <input type="text" name="location" placeholder="Court / Venue (optional)" />
      </div>
      <div></div>

      <div>
        <label>Player A name</label>
        <input type="text" name="player_a_name" placeholder="Player A" />
      </div>
      <div>
        <label>Player A UTR</label>
        <input type="number" step="0.1" name="player_a_utr" placeholder="(optional)" />
      </div>

      <div>
        <label>Player B name</label>
        <input type="text" name="player_b_name" placeholder="Player B" />
      </div>
      <div>
        <label>Player B UTR</label>
        <input type="number" step="0.1" name="player_b_utr" placeholder="(optional)" />
      </div>

      <div class="full terms">
        <input type="checkbox" id="terms" name="terms_accepted" />
        <label for="terms">I accept the terms</label>
      </div>

      <div class="full">
        <details class="tnc">
          <summary>View Terms & Conditions</summary>
          <div style="font-size:12px;color:#374151;margin-top:6px;line-height:1.45">
            <p><strong>Usage:</strong> By uploading you confirm you own the rights or have permission from the owner.</p>
            <p><strong>Privacy:</strong> Videos may be processed by third-party analytics to generate statistics.</p>
            <p><strong>Charges:</strong> Analysis may incur costs; invalid or corrupted uploads may be rejected.</p>
            <p><strong>Support:</strong> Contact info@nextpointtennis.com for assistance.</p>
          </div>
        </details>
      </div>

      <div class="full btn-row">
        <button type="button" class="btn-outline" id="checkBtn">Check Video</button>
        <button type="button" class="btn" id="submitBtn" disabled>Upload and Submit</button>
        <button type="button" class="btn-outline" id="cancelBtn" style="display:none">Cancel Task</button>
      </div>

      <div class="full divider"></div>

      <!-- TASK ID / STATUS / PROGRESS % -->
      <div class="full status-row">
        <div class="col">
          <div class="col-title">TASK ID</div>
          <div class="col-value mono" id="taskId">—</div>
        </div>
        <div class="col">
          <div class="col-title">STATUS</div>
          <div class="col-value" id="stage">waiting…</div>
        </div>
        <div class="col">
          <div class="col-title">PROGRESS %</div>
          <div class="bar-wrap">
            <div class="bar">
              <div class="fill" id="barFill" style="width:0%"></div>
              <div class="pct" id="pctInside">0%</div>
            </div>
            <div class="anchors"><span>0%</span><span>100%</span></div>
          </div>
        </div>
      </div>

      <div class="full">
        <div class="log" id="log"></div>
      </div>
    </form>
  </div>
</div>

<script>
(function(){
  const form = document.getElementById('form');
  const logBox = document.getElementById('log');
  const stageEl = document.getElementById('stage');
  const taskIdEl = document.getElementById('taskId');
  const barFill = document.getElementById('barFill');
  const pctInside = document.getElementById('pctInside');
  const submitBtn = document.getElementById('submitBtn');
  const checkBtn = document.getElementById('checkBtn');
  const cancelBtn = document.getElementById('cancelBtn');
  const terms = document.getElementById('terms');

  // Default match date to today
  document.addEventListener('DOMContentLoaded', () => {
    const d = document.getElementById('match_date');
    if (d && !d.value) {
      try { d.value = new Date().toISOString().slice(0,10); } catch(e){}
    }
  });

  let pollTimer = null;
  let pseudo = makePseudoProgress();
  let checkedUrl = null;

  function log(line){
    const ts = new Date().toLocaleTimeString();
    logBox.textContent += `${ts} ${line}\n`;
    logBox.scrollTop = logBox.scrollHeight;
  }
  function setProgress(p){
    if (p == null || Number.isNaN(p)) p = 0;
    p = Math.max(0, Math.min(100, Math.round(p)));
    pctInside.textContent = p + '%';
    barFill.style.width = p + '%';
  }
  function markDone(){
    stageEl.textContent = 'completed';
    setProgress(100);
    submitBtn.disabled = false;
  }
  function makePseudoProgress(){
    let p = 0;
    return {
      reset(){ p = 0; },
      tick(){ if (p < 90){ p += Math.max(0.2, (90 - p) * 0.015); } return Math.min(90, Math.round(p)); }
    };
  }

  async function poll(tid){
    if (!tid) return;
    try{
      const r = await fetch(`/upload/api/task-status?task_id=${encodeURIComponent(tid)}`, {cache:'no-store'});
      const j = await r.json();
      const status = (j.status || '').toLowerCase() || (j.data && (j.data.task_status || j.data.status)) || 'processing';
      stageEl.textContent = status;

      const d = j.data || {};
      let prog = d.task_progress ?? d.progress ?? j.task_progress ?? j.progress ?? null;
      if (prog == null) prog = (status === 'completed') ? 100 : pseudo.tick();
      setProgress(prog);

      if (status === 'completed' || status === 'success' || status === 'succeeded' || prog >= 100){
        markDone();
        clearInterval(pollTimer); pollTimer = null;
        log('analysis complete ✓');
      }
    }catch(e){ log(`status error: ${e}`); }
  }

  function collectMeta(){
    const fd = new FormData(form);
    return {
      customer_name: (fd.get('customer_name')||'').trim(),
      match_date: (fd.get('match_date')||'').trim(),
      start_time: (fd.get('start_time')||'').trim(),
      location: (fd.get('location')||'').trim(),
      player_a_name: (fd.get('player_a_name')||'').trim() || 'Player A',
      player_b_name: (fd.get('player_b_name')||'').trim() || 'Player B',
      player_a_utr: (fd.get('player_a_utr')||'').trim(),
      player_b_utr: (fd.get('player_b_utr')||'').trim(),
      terms_accepted: terms.checked ? '1' : '0',
    };
  }

  // CHECK
  checkBtn.addEventListener('click', async ()=>{
    logBox.textContent = '';
    submitBtn.disabled = true;
    stageEl.textContent = 'waiting…';
    setProgress(0); pseudo.reset();

    const f = document.getElementById('file').files[0];
    if (!f){ log('error: no file selected'); return; }
    if (!terms.checked){ log('please accept the terms first'); return; }

    const fd = new FormData(form);

    log('uploading to file server…');
    try{
      const r = await fetch('/upload/api/check-video', { method:'POST', body:fd });
      const j = await r.json();
      if (!j.ok){ log(`check error: ${j.error || 'failed'}`); return; }

      checkedUrl = j.video_url;
      log(`uploaded ${f.name} (${f.size} bytes)`);
      log('video check completed ✓');

      submitBtn.disabled = false;
      stageEl.textContent = 'ready';
    }catch(e){
      log(`error: ${e}`);
    }
  });

  // SUBMIT
  submitBtn.addEventListener('click', async ()=>{
    if (!checkedUrl){ log('please run Check Video first'); return; }
    if (!terms.checked){ log('please accept the terms first'); return; }

    submitBtn.disabled = true;
    stageEl.textContent = 'processing';
    setProgress(0); pseudo.reset();

    const email = (new FormData(form).get('email')||'').trim().toLowerCase();
    const meta = collectMeta();

    log('submitting to Analytics Console…');
    try{
      const r = await fetch('/upload/api/upload', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ video_url: checkedUrl, email, meta })
      });
      const j = await r.json();
      if (!j.ok){ submitBtn.disabled = false; log(`submit error: ${j.error || 'failed'}`); return; }

      const tid = j.task_id;
      taskIdEl.textContent = tid || '—';
      cancelBtn.style.display = tid ? '' : 'none';

      log(`task ${tid} submitted to Analytics Console…`);

      clearInterval(pollTimer);
      pollTimer = setInterval(()=>poll(tid), 2000);
      poll(tid);
    }catch(e){
      submitBtn.disabled = false;
      log(`error: ${e}`);
    }
  });

  // CANCEL
  cancelBtn.addEventListener('click', async ()=>{
    const tid = taskIdEl.textContent.trim();
    if (!tid || tid==='—') return;
    cancelBtn.disabled = true;
    try{
      const r = await fetch('/upload/api/cancel-task', {
        method:'POST',
        headers:{'Content-Type':'application/x-www-form-urlencoded'},
        body: new URLSearchParams({ task_id: tid })
      });
      const j = await r.json();
      if (j.ok){
        log('task cancelled ✓');
        stageEl.textContent = 'cancelled';
      }else{
        log(`cancel error: ${j.error || JSON.stringify(j.data) || 'failed'}`);
      }
    }catch(e){
      log(`cancel error: ${e}`);
    }finally{
      cancelBtn.disabled = false;
    }
  });
})();
</script>
</body>
</html>
