<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Upload Match Video</title>
  <style>
    html, body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: url('{{ url_for("ui.static", filename="upload/background-clean-male-serve.jpg") }}');
      background-size: cover;
      color: #ffffff;
    }
    .overlay { background: rgba(0, 0, 0, 0.6); min-height: 100vh; display: flex; justify-content: center; align-items: center; padding: 20px; }
    .container { background: rgba(0, 128, 0, 0.2); border: 2px solid #00ff80; border-radius: 15px; padding: 20px; width: 100%; max-width: 640px; text-align: center; box-shadow: 0 0 20px #00ff80; }
    h2 { font-size: 1.6rem; margin-bottom: 12px; }
    .pill { display:inline-block; padding:6px 10px; border-radius:999px; border:1px solid #00ff80; background: rgba(0,0,0,.2); font-size:.85rem; margin: 6px 0 14px; }
    .warn { color:#fca5a5; border-color:#fca5a5 }
    .grid { display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px }
    .grid .col-2 { grid-column: span 2 }
    label { display:block; font-size:.9rem; text-align:left; margin: 2px 0 4px; opacity:.9 }
    input[type="text"], input[type="email"], input[type="file"], input[type="date"], input[type="time"] {
      width: 100%; padding: 10px; border-radius: 6px; border: none; font-size: .95rem;
    }
    .btn { width: 100%; background-color: #00ff80; color: #000; padding: 12px; border: none; border-radius: 6px; font-size: 1rem; cursor: pointer; transition: background .25s ease; }
    .btn:hover { background-color: #00cc66; }
    .btn.secondary { background: transparent; border:1px solid #00ff80; color:#00ff80 }
    .btn.danger { background: transparent; border:1px solid #f87171; color:#f87171 }
    .row { margin-top: 10px }
    .progress-bar { background-color: #ffffff40; border-radius: 8px; margin-top: 10px; height: 12px; overflow: hidden; }
    .progress-bar-fill { height: 100%; width: 0%; background-color: #00ff80; transition: width 0.3s ease-in-out; }
    .spinner { display: none; margin: 14px auto; border: 6px solid #ccc; border-top: 6px solid #00ff80; border-radius: 50%; width: 36px; height: 36px; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    #status, #checkBox {
      background: rgba(255, 255, 255, 0.08);
      border-radius: 10px; padding: 12px; margin-top: 12px; font-size: 0.95rem;
      text-align: left; border: 1px solid #00ff80; white-space: pre-wrap;
    }
    #subtasks { margin-top: 8px; font-size: 0.9rem; opacity: .95; text-align:left }
    #subtasks code { display:block; background: rgba(0,0,0,.25); padding:8px; border-radius:8px; border:1px solid #00ff80; }
    .muted { opacity:.8; font-size:.85rem }
    .terms { margin-top: 14px; text-align:left; font-size:.85rem; opacity:.95 }
    a { color:#8cf5c0; text-decoration: none } a:hover{ text-decoration: underline }
    .hidden { display:none }
  </style>
</head>
<body>
  <div class="overlay">
    <div class="container" data-max-mb="{{ max_upload_mb }}">
      <h2>üéæ Upload Match Video</h2>
      {% if not dropbox_ready %}<div class="pill warn">Dropbox server credentials are not configured.</div>{% endif %}
      {% if not sportai_ready %}<div class="pill warn">SPORT_AI_TOKEN is not configured.</div>{% endif %}
      <div class="pill">Target folder: <strong>{{ target_folder }}</strong></div>

      <!-- Step 0: metadata + file -->
      <form id="metaForm" class="grid" enctype="multipart/form-data">
        <div class="col-2">
          <label>Customer name (required)</label>
          <input type="text" name="customer_name" required placeholder="Full name" />
        </div>

        <div class="col-2">
          <label>Email (required ‚Äî used as your customer ID)</label>
          <input type="email" name="email" required placeholder="you@example.com" />
        </div>

        <div class="col-2">
          <label>Match video (MP4/MOV)</label>
          <input type="file" name="video" accept=".mp4,.mov" required />
        </div>

        <div><label>Match date</label><input type="date" name="match_date"></div>
        <div><label>Start time</label><input type="time" name="start_time" step="1"></div>
        <div class="col-2"><label>Location</label><input type="text" name="location" placeholder="Club / Court"></div>

        <div><label>Server (Player A) name</label><input type="text" name="player_a_name" placeholder="Player A"></div>
        <div><label>Receiver (Player B) name</label><input type="text" name="player_b_name" placeholder="Player B"></div>
        <div><label>Player A UTR</label><input type="text" name="player_a_utr" placeholder="e.g., 10.5"></div>
        <div><label>Player B UTR</label><input type="text" name="player_b_utr" placeholder="e.g., 9.8"></div>

        <div class="col-2 terms">
          <label>
            <input type="checkbox" id="terms" name="terms_accepted" required>
            I accept that processing can take time; AI can be imperfect; and that
            the video must meet minimum quality requirements. For questions, contact
            <a href="mailto:info@nextpointtennis.com">info@nextpointtennis.com</a>.
          </label>
        </div>

        <div class="col-2 row">
          <button id="checkBtn" type="button" class="btn">‚úÖ Check Video Readiness</button>
        </div>
      </form>

      <!-- Results of readiness check -->
      <div id="checkBox" class="hidden"></div>

      <!-- Step 1: submit to SportAI once check passes -->
      <div class="grid">
        <div class="col-2 row">
          <button id="uploadBtn" class="btn hidden">üì§ Submit to SportAI & Start Analysis</button>
        </div>
        <div class="col-2 row">
          <button id="cancelBtn" class="btn danger hidden" type="button">‚õî Cancel Task</button>
        </div>
      </div>

      <!-- Progress + status -->
      <div class="spinner" id="spinner"></div>
      <div class="progress-bar"><div class="progress-bar-fill" id="progressFill"></div></div>
      <div id="status"></div>
      <div id="subtasks"></div>

      <div class="muted terms">
        By submitting, you authorize NextPoint to process the video with SportAI. You‚Äôll receive an email when analysis completes.
      </div>
    </div>
  </div>

  <script>
    // ---- Elements
    const metaForm     = document.getElementById("metaForm");
    const checkBtn     = document.getElementById("checkBtn");
    const uploadBtn    = document.getElementById("uploadBtn");
    const cancelBtn    = document.getElementById("cancelBtn");
    const checkBox     = document.getElementById("checkBox");
    const statusBox    = document.getElementById("status");
    const subtasksBox  = document.getElementById("subtasks");
    const spinner      = document.getElementById("spinner");
    const progressFill = document.getElementById("progressFill");

    const MAX_MB    = parseInt(document.querySelector(".container").dataset.maxMb || "200", 10);
    const MAX_BYTES = MAX_MB * 1024 * 1024;

    // ---- State
    let lastTaskId    = null;
    let checkedVideo  = null;  // direct URL from readiness check
    let sharedLink    = null;  // Dropbox share URL (for reference)
    let pollTimer     = null;

    // ---- Helpers (UI)
    const show   = (el) => el.classList.remove("hidden");
    const hide   = (el) => el.classList.add("hidden");
    const pct0   = (x) => (typeof x === "number" ? Math.max(0, Math.min(100, Math.round(x * 100))) : 0);
    const setBar = (p) => { progressFill.style.width = `${p}%`; };
    const addLine = (t) => { statusBox.textContent += (statusBox.textContent ? "\n" : "") + t; };
    const clearStatus = () => { statusBox.textContent = ""; };

    const renderSubtasks = (obj) => {
      if (!obj || typeof obj !== "object") { subtasksBox.innerHTML = ""; return; }
      const pretty = JSON.stringify(obj, null, 2);
      subtasksBox.innerHTML = `<strong>Subtasks</strong><code>${pretty}</code>`;
    };

    // ---- Readiness check (two ways):
    //  We upload the chosen file to Dropbox (server-side), then call SportAI /videos/check.
    checkBtn.addEventListener("click", async () => {
      clearStatus();
      setBar(0);
      hide(uploadBtn);
      hide(cancelBtn);
      hide(checkBox);
      spinner.style.display = "block";

      try {
        const fd = new FormData(metaForm);
        const file = metaForm.querySelector('input[name="video"]').files[0];
        if (!file) { spinner.style.display="none"; addLine("‚ùå Please choose a video file."); return; }
        if (file.size > MAX_BYTES) {
          spinner.style.display="none";
          addLine(`‚ùå File is ${Math.round(file.size/1024/1024)}MB > ${MAX_MB}MB (server limit).`);
          return;
        }

        // Call our /upload/api/check endpoint (multipart). It uploads to Dropbox + calls SportAI /videos/check.
        const res = await fetch("/upload/api/check", { method: "POST", body: fd });
        const txt = await res.text(); let data; try { data = JSON.parse(txt); } catch { data = { _raw: txt }; }

        if (!res.ok || !data?.ok) {
          spinner.style.display = "none";
          const msg = data?.error || (data?._raw || `HTTP ${res.status} ${res.statusText}`);
          addLine(`‚ùå Readiness check failed: ${msg}`);
          return;
        }

        // Save returned URLs for the submit step
        checkedVideo = data.video_url || null;
        sharedLink   = data.share_url || null;

        // Show a light summary from the check payload (structure varies across tenants)
        const summary = (() => {
          const c = data.check || {};
          // try a few common things if present
          const top = (c.data && (c.data.details || c.data.summary)) || c.summary || c.details || c;
          return typeof top === "object" ? JSON.stringify(top, null, 2) : String(top);
        })();

        checkBox.innerHTML = `
          <div><strong>‚úÖ Video readiness check passed.</strong></div>
          ${sharedLink ? `<div class="muted">Source: <a href="${sharedLink}" target="_blank" rel="noreferrer">${sharedLink}</a></div>` : ``}
          <div style="margin-top:8px"><strong>Check result:</strong></div>
          <pre style="white-space:pre-wrap">${summary}</pre>
        `;
        show(checkBox);
        show(uploadBtn);
        spinner.style.display = "none";
        setBar(10);
      } catch (e) {
        spinner.style.display = "none";
        addLine(`‚ùå Readiness check error: ${String(e)}`);
      }
    });

    // ---- Submit to SportAI & start polling
    uploadBtn.addEventListener("click", async () => {
      if (!checkedVideo) { addLine("‚ùå Please run the readiness check first."); return; }

      clearStatus();
      spinner.style.display = "block";
      setBar(20);
      addLine("üì§ Submitting to SportAI‚Ä¶");

      try {
        // Build metadata (the backend may forward into SportAI metadata and/or store for reporting)
        const meta = {
          customer_name: metaForm.customer_name.value.trim(),
          match_date: metaForm.match_date.value,
          start_time: metaForm.start_time.value,
          location: metaForm.location.value.trim(),
          player_a_name: metaForm.player_a_name.value.trim(),
          player_b_name: metaForm.player_b_name.value.trim(),
          player_a_utr: metaForm.player_a_utr.value.trim(),
          player_b_utr: metaForm.player_b_utr.value.trim(),
          terms_accepted: metaForm.terms_accepted.checked,
        };
        const payload = {
          video_url: checkedVideo,
          email: metaForm.email.value.trim().toLowerCase(),
          metadata: meta,   // harmless if server ignores; useful if it forwards/stores
        };

        const res = await fetch("/upload/api/upload", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        const txt = await res.text(); let data; try { data = JSON.parse(txt); } catch { data = { _raw: txt }; }

        if (!res.ok || data?.error || !data?.task_id) {
          spinner.style.display = "none";
          const msg = data?.error || (data?._raw || `HTTP ${res.status} ${res.statusText}`);
          addLine(`‚ùå Submit failed: ${msg}`);
          return;
        }

        lastTaskId = data.task_id;
        addLine("‚úÖ Submitted. Polling for status‚Ä¶");
        show(cancelBtn);
        setBar(30);
        poll(lastTaskId);
      } catch (e) {
        spinner.style.display = "none";
        addLine(`‚ùå Submit error: ${String(e)}`);
      }
    });

    // ---- Cancel current task
    cancelBtn.addEventListener("click", async () => {
      if (!lastTaskId) return;
      try {
        cancelBtn.disabled = true;
        const res = await fetch(`/upload/api/cancel?task_id=${encodeURIComponent(lastTaskId)}`, { method: "POST" });
        const txt = await res.text(); let data; try { data = JSON.parse(txt); } catch { data = { _raw: txt }; }
        if (!res.ok || data?.error) {
          addLine(`‚ö†Ô∏è Cancel failed: ${data?.error || data?._raw || res.status}`);
        } else {
          addLine("‚õî Task cancelled.");
          if (pollTimer) clearInterval(pollTimer);
          setBar(0);
        }
      } finally {
        cancelBtn.disabled = false;
      }
    });

    // ---- Poll helper
    function poll(taskId) {
      if (pollTimer) clearInterval(pollTimer);
      let attempts = 0, maxAttempts = 180, delay = 5000;
      pollTimer = setInterval(async () => {
        attempts++;
        try {
          const res  = await fetch(`/upload/api/task-status?task_id=${encodeURIComponent(taskId)}`);
          const txt  = await res.text(); let data; try { data = JSON.parse(txt); } catch { data = { _raw: txt }; }

          const d    = data?.data || {};
          const stat = d.task_status || data?.status || "unknown";
          const p    = pct0(d.task_progress);
          const subt = d.subtask_progress;
          const totS = typeof d.total_subtask_progress === "number" ? pct0(d.total_subtask_progress) : null;

          setBar(p);
          if (subt) renderSubtasks(subt);

          if (stat === "completed") {
            setBar(100);
            addLine("‚úÖ Analysis complete! JSON downloaded and ingested.");
            clearInterval(pollTimer);
            spinner.style.display = "none";
            hide(cancelBtn);
          } else if (stat === "failed" || stat === "cancelled") {
            addLine(`‚ùå ${stat.charAt(0).toUpperCase()+stat.slice(1)}.`);
            clearInterval(pollTimer);
            spinner.style.display = "none";
            hide(cancelBtn);
          } else if (attempts >= maxAttempts) {
            addLine("‚ö†Ô∏è Timeout. Try again later.");
            clearInterval(pollTimer);
            spinner.style.display = "none";
            hide(cancelBtn);
          } else {
            const extra = totS !== null ? ` | subtasks ${totS}%` : "";
            addLine(`üîÑ Status: ${stat} (${p}%)${extra}`);
          }
        } catch (e) {
          addLine(`‚ùå Polling failed: ${String(e)}`);
          clearInterval(pollTimer);
          spinner.style.display = "none";
          hide(cancelBtn);
        }
      }, delay);
    }
  </script>
</body>
</html>
