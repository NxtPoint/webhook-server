<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>NextPoint Admin</title>
  <style>
    body{margin:0;font-family:Inter,Arial,Helvetica,sans-serif;background:#0b1220;color:#e6f0ff}
    .wrap{max-width:1100px;margin:24px auto;padding:0 16px;display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .card{background:#0f172a;border:1px solid #203154;border-radius:12px;padding:16px;box-shadow:0 0 0 1px rgba(0,0,0,.05) inset}
    h3{margin:0 0 10px 0;font-weight:600}
    input,textarea,button{border-radius:8px;border:1px solid #334155;background:#0b1220;color:#e6f0ff}
    input,textarea{width:100%;padding:10px;font-size:14px}
    textarea{min-height:110px}
    .row{display:flex;gap:8px;align-items:center;margin-top:8px}
    .btn{cursor:pointer;padding:10px 12px;background:#10b981;border:1px solid #22c55e;color:#062b1f;font-weight:600}
    .btn.dim{background:#1f2937;border-color:#334155;color:#cbd5e1}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;font-size:13px;white-space:pre-wrap;background:#0b1220;border:1px solid #203154;border-radius:8px;padding:10px}
    .full{grid-column:1 / span 2}
    .pill{display:inline-block;margin:6px 0;padding:4px 8px;border-radius:999px;border:1px solid #22c55e;background:rgba(34,197,94,.08);font-size:.85rem}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h3>Configuration</h3>
      <div>Base URL</div>
      <input id="baseUrl" value="https://api.nextpointtennis.com" />
      <div style="margin-top:10px">OPS KEY</div>
      <input id="opsKey" value="270fb80a747d459eafded0ae67b9b8f6" />
      <div class="pill">If you rotate the key in Render, update it here too.</div>
    </div>

    <div class="card">
      <h3>DB & Views</h3>
      <div class="row">
        <button class="btn" onclick="initDb()">Init DB</button>
        <button class="btn" onclick="initViews()">Init Views</button>
        <button class="btn dim" onclick="dbCounts()">DB Counts</button>
      </div>
      <div id="dbOut" class="mono" style="margin-top:10px;height:180px;overflow:auto">Result will appear here…</div>
    </div>

    <div class="card full">
      <h3>Read-only SQL</h3>
      <textarea id="sqlBox">select * from vw_session_summary limit 5;</textarea>
      <div class="row"><button class="btn" onclick="runSql()">Run</button><span>Only SELECT/CTEs allowed, auto LIMIT 200 applied.</span></div>
      <div id="sqlOut" class="mono" style="margin-top:10px;height:120px;overflow:auto">Rows will appear here…</div>
    </div>

    <div class="card">
      <h3>Sessions</h3>
      <div class="row"><button class="btn dim" onclick="listSessions()">List Sessions</button></div>
      <input id="sessionUid" placeholder="session_uid" style="margin-top:8px" />
      <div class="row">
        <button class="btn" onclick="reconcile()">Reconcile</button>
        <button class="btn dim" onclick="deleteSession()">Delete</button>
      </div>
      <div id="sessOut" class="mono" style="margin-top:10px;height:220px;overflow:auto">Session tools output…</div>
    </div>

    <div class="card">
      <h3>Upload & Tasks</h3>
      <div class="row"><a class="btn dim" href="/upload" target="_blank">Open Upload Page</a></div>
      <input id="taskId" placeholder="task id" style="margin-top:8px" />
      <div class="row">
        <button class="btn dim" onclick="checkStatus()">Check Task Status</button>
        <button class="btn" onclick="resumePoller()">Resume Poller</button>
        <button class="btn dim" onclick="ingestLog()">Ingest Log</button>
      </div>
      <div id="taskOut" class="mono" style="margin-top:10px;height:220px;overflow:auto">{ }</div>
    </div>

    <div class="card full">
      <h3>Manual JSON Ingest</h3>
      <div class="row">
        <input id="filePick" type="file" />
        <button class="btn" onclick="ingestJson()">Ingest JSON</button>
      </div>
      <div class="pill">Use only if the auto-ingest missed a file. This posts to /ops/ingest-file?replace=1</div>
      <div id="ingestOut" class="mono" style="margin-top:10px;height:140px;overflow:auto">Manual ingest output…</div>
    </div>
  </div>

<script>
const $ = (id)=>document.getElementById(id);
const BU = ()=>$('baseUrl').value.trim().replace(/\/$/,'');
const KEY= ()=>$('opsKey').value.trim();

async function j(url, opts){const r=await fetch(url,opts);let t;try{t=await r.json()}catch{t=await r.text()}return {r,t};}
function show(el, val){$(el).textContent=(typeof val==='string')?val:JSON.stringify(val,null,2);}

async function initDb(){show('dbOut','…');const {t}=await j(`${BU()}/ops/init-db?key=${KEY()}`);show('dbOut',t);}
async function initViews(){show('dbOut','…');const {t}=await j(`${BU()}/ops/init-views?key=${KEY()}`);show('dbOut',t);}
async function dbCounts(){show('dbOut','…');const {t}=await j(`${BU()}/ops/db-counts?key=${KEY()}`);show('dbOut',t);}

async function runSql(){
  const q = encodeURIComponent($('sqlBox').value);
  show('sqlOut','…');
  const {t}=await j(`${BU()}/ops/sql?key=${KEY()}&q=${q}`);
  show('sqlOut',t);
}

async function listSessions(){show('sessOut','…');const {t}=await j(`${BU()}/ops/list-sessions?key=${KEY()}`);show('sessOut',t);}
async function reconcile(){
  const u=encodeURIComponent($('sessionUid').value.trim());
  if(!u) return show('sessOut','Enter a session_uid first.');
  show('sessOut','…');
  const {t}=await j(`${BU()}/ops/reconcile?key=${KEY()}&session_uid=${u}`);
  show('sessOut',t);
}
async function deleteSession(){
  const u=encodeURIComponent($('sessionUid').value.trim());
  if(!u) return show('sessOut','Enter a session_uid first.');
  if(!confirm(`Delete session ${u}?`)) return;
  const {t}=await j(`${BU()}/ops/delete-session?key=${KEY()}&session_uid=${u}`);
  show('sessOut',t);
}

async function checkStatus(){
  const id=$('taskId').value.trim();
  if(!id) return show('taskOut','Enter a task id first.');
  show('taskOut','…');
  const {t}=await j(`/upload/task_status/${id}`);
  show('taskOut',t);
}
async function resumePoller(){
  const id=$('taskId').value.trim();
  if(!id) return show('taskOut','Enter a task id first.');
  show('taskOut','…');
  const {t}=await j(`/upload/resume/${id}`, {method:'GET'});
  show('taskOut',t);
}
async function ingestLog(){
  const {t}=await j(`/upload/debug/ingest-log`);
  show('taskOut',t);
}
async function ingestJson(){
  const f=$('filePick').files[0]; if(!f){return show('ingestOut','Pick a file first.');}
  const fd = new FormData(); fd.append('file', f, f.name);
  const url = `${BU()}/ops/ingest-file?key=${KEY()}&replace=1`;
  show('ingestOut','Uploading…');
  const r = await fetch(url, {method:'POST', body: fd});
  let t; try{t=await r.json()}catch{t=await r.text()}
  show('ingestOut', t);
}
</script>
</body>
</html>
